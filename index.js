const canvas = document.querySelector('canvas');
const c = canvas.getContext('2d'); // c = context


canvas.width = 1800;
canvas.height = 1100;



const collisionsMap = []
for (let i = 0; i < collisions.length; i+=150) { // 150 = width of the map
    collisionsMap.push(collisions.slice(i,i + 150)) // strange numbers: 1025 and garbage number.
}


const boundaries = []
const offset = {
    x: -800,
    y: -2350
}


collisionsMap.forEach ((row,i) => {
    row.forEach((symbol,j) => {
        if (symbol > 0)
        boundaries.push(new Boundary({
            position:{
            x: j * Boundary.width + offset.x,
            y: i * Boundary.height + offset.y
        }}))
    })
})


const image = new Image()
image.src = './img/map.png'


const FGimage = new Image() // FG = ForeGround
FGimage.src = './img/foreground.png'


const plDownImage = new Image() // plDownImage = playerImage for bottom view of player
plDownImage.src ='./img/playerDown.png'


const plUpImage = new Image()  // same as plDownImage but for Top view of player and etc.
plUpImage.src ='./img/playerUp.png'


const plLeftImage = new Image() 
plLeftImage.src ='./img/playerLeft.png'


const plRightImage = new Image() 
plRightImage.src ='./img/playerRight.png'


const npc1Image = new Image()
npc1Image.src = './heroes/babushka.png'

const npc2Image = new Image()
npc2Image.src = './heroes/daniil.png'


const npc3Image = new Image()
npc3Image.src = './heroes/fermer.png'

const characters = [
    new Character({
        position: { x: 1447, y: 467 },
        image: npc1Image,
        frames: { max: 1 },
        name: "Леночка",
        dialogues: {
            'start': {
                text: "Ах, прохожий! Извините, что остановила... Вижу, вы спешите, но не могу не поделиться. Видите ту старую липу у дороги? Она помнит ещё мою прабабушку. Говорят, под ней когда-то собирались сельчане, решали общие дела, пели песни... Теперь же мимо неё все бегут, не замечая.",
                next: 'memory'
            },
            'memory': {
                text: "Я библиотекарь, работаю с книгами всю жизнь. И знаете, самые ценные для меня - не те, что на полках, а те, что в памяти людей. Старые фотографии, письма, дневники... В них - душа времени. Недавно нашла дневник учительницы 30-х годов. Она писала: 'Дети рисуют мелом на асфальте дома с трубой - символ тепла и семьи'. А что рисуют современные дети?",
                next: 'reflection1'
            },
            'reflection1': {
                text: "Иногда вечерами, когда библиотека пустеет, я остаюсь одна с этими молчаливыми свидетелями эпох. Каждая книга, каждая фотография - это мост между прошлым и будущим. Мой дед говорил: 'Народ, не помнящий своего прошлого, не имеет будущего'. Я тогда не понимала, сейчас же эти слова наполняются глубоким смыслом.",
                next: 'story'
            },
            'story': {
                text: "В войну нашу библиотеку не тронули. Говорили, немецкий офицер, сам бывший учитель, приказал сохранить книги. А после войны именно здесь собирались вернувшиеся фронтовики, читали письма, искали друг друга... Эти стены впитывали и радость, и горе целых поколений. Сейчас молодёжь редко заходит - всё в телефонах, в виртуальном мире.",
                next: 'question1'
            },
            'question1': "А вам знакомо это чувство - связь с местом, где выросли? Ощущение, что ты - часть чего-то большего, что было до тебя и останется после?",
            
            'patriotic_response': {
                text: "Понимаю... Это как корни у дерева - чем глубже, тем крепче стоит. Знаете, я часто думаю: патриотизм - это не громкие слова на площадях, а тихая, ежедневная работа. Работа памяти, работа души. Когда ты знаешь историю своего края не по учебникам, а по рассказам бабушек, по старым фотографиям, по названиям улиц...",
                next: 'continuation1'
            },
            'neutral_response': {
                text: "Понимаю... Это как корни у дерева - чем глубше, тем крепче стоит. Знаете, я часто думаю: патриотизм - это не громкие слова на площадях, а тихая, ежедневная работа. Работа памяти, работа души. Когда ты знаешь историю своего края не по учебникам, а по рассказам бабушек, по старым фотографиям, по названиям улиц...",
                next: 'continuation1'
            },
            'negative_response': {
                text: "Вот как... Знаете, я встречала разных людей. Одни видят в прошлом только тяготы и лишения, другие - мудрость и силу. Но история, как книга: её можно читать поверхностно, а можно вникать в каждое слово. Мой учитель истории говорил: 'Не судите прошлое по меркам настоящего - у каждого времени свои вызовы и свои ответы'.",
                next: 'continuation2'
            },
            
            'continuation1': {
                text: "Вот смотрю я на молодых родителей, которые приводят детей в библиотеку. Одни показывают им книги своих детства, рассказывают о том, как сами здесь сидели. Другие же просто берут новые издания и уходят. И я думаю: какие ценности передадут они своим детям? Что останется в их памяти через годы?",
                next: 'story2'
            },
            'continuation2': {
                text: "Бывают дни, когда в библиотеку почти никто не приходит. Сижу одна, перебираю старые подшивки газет. 60-е годы: энтузиазм, вера в будущее. 90-е: растерянность, но и надежда. Наши дни... А какие мы оставим свидетельства о себе? Цифровые следы, которые исчезнут при первом же сбое системы?",
                next: 'story2'
            },
            
            'story2': {
                text: "Недавно ко мне пришла девочка лет десяти. Попросила книгу о нашем городе для школьного проекта. Я дала ей старый альбом с фотографиями. Она смотрела на снимки 50-летней давности и не могла поверить, что это те же улицы, те же дома... 'А где же все люди?' - спросила она. 'Они здесь,' - ответила я, - 'в наших воспоминаниях, в наших делах'.",
                next: 'reflection2'
            },
            'reflection2': {
                text: "Мы часто ищем героев в книгах, в кино, а они рядом - в обычных людях, которые сохраняют, передают, помнят. Учитель, который работает в сельской школе 40 лет. Врач, который знает историю болезней целых семей. Библиотекарь... Мы - хранители. Хранители памяти, традиций, духа места.",
                next: 'question2'
            },
            'question2': "Как вы думаете, что важнее для человека - знать историю своей малой родины или стремиться к чему-то новому, неизведанному?",
            
            'patriotic_final': {
                text: "Мудро... Баланс между уважением к прошлому и стремлением в будущее - вот что делает человека по-настоящему сильным. Дерево не может расти вверх, не имея корней. Но и корни без роста - это просто пень. Наша задача - быть тем мостом, который соединяет эпохи, передаёт самое ценное следующим поколениям.",
                next: 'conclusion'
            },
            'neutral_final': {
                text: "Мудро... Баланс между уважением к прошлому и стремлением в будущее - вот что делает человека по-настоящему сильным. Дерево не может расти вверх, не имея корней. Но и корни без роста - это просто пень. Наша задача - быть тем мостом, который соединяет эпохи, передаёт самое ценное следующим поколениям.",
                next: 'conclusion'
            },
            'negative_final': {
                text: "Интересная позиция... Знаете, я тоже когда-то думала, что будущее важнее прошлого. Но с годами поняла: невозможно строить дом без фундамента. Новое вырастает из старого, как молодые побеги из старого дерева. Отвергая свои корни, мы рискуем стать перекати-полем - без направления, без причала.",
                next: 'conclusion'
            },
            
            'conclusion': {
                text: "Спасибо, что выслушали старую библиотекаршу. Иногда так хочется поделиться этими мыслями... Заходите как-нибудь в библиотеку - покажу вам те самые старые альбомы, дневники. Может, и вы найдёте в них что-то важное для себя. Ведь каждый из нас - не просто прохожий, а наследник великой истории.",
                next: 'end'
            },
            'end': "Всего вам доброго! И помните: самые важные книги ещё не написаны - их пишет сама жизнь."
        },
        choices: {
            'question1': [
                { 
                    text: "Да, я чувствую эту связь", 
                    value: 1,
                    nextBranch: 'patriotic_response'
                },
                { 
                    text: "Иногда задумываюсь об этом", 
                    value: 2,
                    nextBranch: 'neutral_response'
                },
                { 
                    text: "Прошлое меня не интересует", 
                    value: 3,
                    nextBranch: 'negative_response'
                }
            ],
            'question2': [
                { 
                    text: "Знать свои корни", 
                    value: 4,
                    nextBranch: 'patriotic_final'
                },
                { 
                    text: "Нужен баланс", 
                    value: 5,
                    nextBranch: 'neutral_final'
                },
                { 
                    text: "Важно только будущее", 
                    value: 6,
                    nextBranch: 'negative_final'
                }
            ]
        }
    }),
    

    new Character({
    position: { x: 3945, y: 656 },
    image: npc2Image,
    frames: { max: 1 },
    name: "Даниил",
    dialogues: {
        'start': {
            text: "Привет! Заметил, как ты на стадион смотришь... Знакомый взгляд. Я сам когда-то так же бегал, каждый день, до седьмого пота. Казалось, весь мир у моих ног. А потом... травма. Колено. Врачи сказали: 'Спорту конец'. Тридцать лет тренировок - и всё в один миг.",
            next: 'reflection1'
        },
        'reflection1': {
            text: "Знаешь, что самое сложное было? Не боль, не операции... А тишина. Просыпаешься утром - и некуда бежать. Пустота. Медали на полке пылятся, а ты сидишь у окна и смотришь, как другие бегут твоей дорогой. Месяц так прожил... Два... А потом пошёл к детям во двор. Просто показать, как правильно мяч бросать.",
            next: 'story1'
        },
        'story1': {
            text: "Помню первого своего воспитанника - Серёжку. Мальчишка тощий, неуклюжий, над ним все смеялись. А глаза... Горящие. Я его полгода тренировал. А потом он на городских соревнованиях третье место взял. Знаешь, что он мне сказал? 'Спасибо, что не бросил'. Вот тогда я понял: может, не зря всё это было.",
            next: 'philosophy1'
        },
        'philosophy1': {
            text: "Мне предлагали в Москву переехать - тренировать в элитной школе. Деньги хорошие, перспективы. А я посмотрел на этих пацанов из нашего района... На их родителей, которые с работы уставшие приходят, но на тренировки детей приводят. И подумал: кто их здесь тренировать будет? Кто им покажет, что значит - не сдаваться?",
            next: 'question1'
        },
        'question1': "Как думаешь, что важнее в жизни - добиваться личных вершин или помогать другим найти их путь?",
        
        'positive_response': {
            text: "Интересно... Знаешь, я тоже долго над этим думал. Кажется, настоящая победа - не когда ты стоишь на пьедестале один, а когда видишь, как твои ученики преодолевают себя. Вот вчера девочка одна, Маша, впервые через 'козла' прыгнула. Месяц боялась, плакала. А вчера прыгнула - и такие у неё глаза сияли! Это дороже любой медали.",
            next: 'continuation1'
        },
        'neutral_response': {
            text: "Интересно... Знаешь, я тоже долго над этим думал. Кажется, настоящая победа - не когда ты стоишь на пьедестале один, а когда видишь, как твои ученики преодолевают себя. Вот вчера девочка одна, Маша, впервые через 'козла' прыгнула. Месяц боялась, плакала. А вчера прыгнула - и такие у неё глаза сияли! Это дороже любой медали.",
            next: 'continuation1'
        },
        'negative_response': {
            text: "Понимаю... Каждый должен сам пройти свой путь. Но знаешь, я замечаю: те, кто добивается настоящих высот, редко приходят к ним в одиночку. За каждым чемпионом стоит тренер, который верил в него, когда другие не верили. Как мой первый наставник, который разглядел в тощем пацаненке будущего спортсмена.",
            next: 'continuation2'
        },
        
        'continuation1': {
            text: "Вот смотрю я иногда на этих детей... Они все такие разные. Кто-то приходит за победой, кто-то - просто от безделья. А через год-два видишь: появляется характер, ответственность, умение работать в команде. Они не просто спортом занимаются - они учатся жизни. И в этом, наверное, моё новое призвание.",
            next: 'story2'
        },
        'continuation2': {
            text: "Бывают дни, когда устаёшь страшно. Дети не слушаются, родители требуют результатов, финансирования нет... И думаешь: 'Может, правда в Москву уехать?' А потом приходишь на стадион, а там твой самый проблемный ученик сам, без напоминаний, кросс бежит. И понимаешь: ради таких моментов стоит оставаться.",
            next: 'story2'
        },
        
        'story2': {
            text: "Был у меня парень, Андрей. Талант нереальный! Все тренеры на него молились. В 16 лет его пригласили в академию олимпийского резерва. Уехал, звёздной болезнью заболел... Через год вернулся - сломленный. Говорит: 'Там я был просто номером, а здесь... здесь меня человеком считают'. Сейчас он у меня помощником работает, своих детей тренирует.",
            next: 'reflection2'
        },
        'reflection2': {
            text: "Иногда родители спрашивают: 'А мой чемпионом станет?' Я всегда отвечаю: 'Главное - чтобы человеком стал'. Спорт ведь не про медали, в конечном счёте. Он про характер, про умение падать и подниматься, про уважение к сопернику. Вот этому я и учу своих ребят.",
            next: 'question2'
        },
        'question2': "Как по-твоему, можно ли быть успешным, оставаясь верным своему городу, своему делу, или нужно искать возможности везде, где они есть?",
        
        'positive_final': {
            text: "Верно подметил... Успех - это не только географическое положение. Это состояние души. Я знаю ребят, которые уехали за границу, стали знаменитыми, но счастья не нашли. И знаю тех, кто остался здесь, открыл маленький бизнес, тренирует детей - и светятся от счастья. Важно найти своё место, а не самое престижное.",
            next: 'conclusion1'
        },
        'neutral_final': {
            text: "Верно подметил... Успех - это не только географическое положение. Это состояние души. Я знаю ребят, которые уехали за границу, стали знаменитыми, но счастья не нашли. И знаю тех, кто остался здесь, открыл маленький бизнес, тренирует детей - и светятся от счастья. Важно найти своё место, а не самое престижное.",
            next: 'conclusion1'
        },
        'negative_final': {
            text: "Понимаю твою точку зрения... Мир большой, возможностей много. Но знаешь, я за свою жизнь понял: где бы ты ни был, ты всегда берёшь с собой свои ценности. Можно быть успешным в любой точке мира, если остаёшься верным себе. А можно иметь всё - и чувствовать себя пустым. Главное - понять, что для тебя по-настоящему важно.",
            next: 'conclusion2'
        },
        
        'conclusion1': {
            text: "Спасибо за беседу... Редко встречаю людей, которые готовы так глубоко о таких вещах говорить. Знаешь, когда я смотрю на молодое поколение, я верю, что не всё потеряно. Что будут те, кто поймёт: настоящая сила - не в мышцах, а в сердце. Не в победах, а в умении поднимать других.",
            next: 'final'
        },
        'conclusion2': {
            text: "Каждый ищет свой путь... И это правильно. Но помни: какие бы высоты ты ни покорял, важно иногда оглянуться назад - не забыть тех, кто тебе помогал в начале пути. Как я не забыл своего первого тренера, который верил в меня, когда я сам в себя не верил.",
            next: 'final'
        },
        'final': "Заходи как-нибудь на тренировку - посмотри, как наши ребята занимаются. Может, и тебе захочется с мячом побросать... В спорте, как и в жизни, главное - начать. А там... там видно будет. Удачи тебе!"
    },
    choices: {
        'question1': [
            { 
                text: "Помогать другим важнее", 
                value: 1,
                nextBranch: 'positive_response'
            },
            { 
                text: "Нужно и то, и другое", 
                value: 2,
                nextBranch: 'neutral_response'
            },
            { 
                text: "Каждый сам за себя", 
                value: 3,
                nextBranch: 'negative_response'
            }
        ],
        'question2': [
            { 
                text: "Верность - это сила", 
                value: 4,
                nextBranch: 'positive_final'
            },
            { 
                text: "Нужен баланс", 
                value: 5,
                nextBranch: 'neutral_final'
            },
            { 
                text: "Нужно искать везде", 
                value: 6,
                nextBranch: 'negative_final'
            }
        ]
    }
}),
    
    
    new Character({
    position: { x: 4711, y: -877 },
    image: npc3Image,
    frames: { max: 4 },
    name: "Михаил Петрович",
    dialogues: {
        'start': {
            text: "А, здравствуй, путник! Вижу, ты обратил внимание на мой сад. Это не просто клумбы и грядки, понимаешь ли... Каждое это деревце, каждый кустик - как страница истории. Вот эта яблоня, например... Её посадил ещё мой дед в голодном 47-м. Говорил: 'Пусть дети знают вкус настоящих яблок, а не только голодных лет'.",
            next: 'memory1'
        },
        'memory1': {
            text: "Я тут уже больше сорока лет работаю. Сначала инженером на заводе был, а на пенсии - душа к земле потянулась. Знаешь, есть что-то волшебное в том, чтобы из маленького семечка вырастить могучее дерево. Как будто продлеваешь жизнь, оставляешь след... Мой сын в городе живёт, зовёт к себе. А я ему: 'Кто же за садом смотреть будет? Кто птиц зимой кормить станет?'",
            next: 'reflection1'
        },
        'reflection1': {
            text: "Вот смотрю я на этих голубей, что на ветках сидят... Их пра-пра-прадеды ещё при моём отце здесь жили. И дубы эти вековые... Они помнят и царя, и революцию, и войну. Стоят себе молча, а сколько могли бы рассказать! Иногда кажется, что деревья - это самые честные историки. Они не переписывают летописи, не искажают факты... Они просто растут.",
            next: 'story1'
        },
        'story1': {
            text: "Был у меня друг, Николай. Мы вместе в саду работали. Он говорил: 'Миша, мы не садовники, мы - хранители'. А потом дети его в Америку забрали. Уехал он, писал сначала, тоскуя по нашему саду. Говорил, там всё красиво, аккуратно, но души нет... Нет этой связи поколений, этой памяти земли. Через год писем не стало.",
            next: 'question1'
        },
        'question1': "Скажи, а ты чувствуешь иногда эту невидимую нить, что связывает тебя с землёй, на которой вырос?",
        
        'positive_response': {
            text: "Вот именно! Это как у дерева корни - чем глубже, тем устойчивее к любым бурям. Знаешь, я часто думаю: настоящая любовь к Родине начинается не с громких слов, а с малого. С заботы о своём дворе, о парке, о речке, в которой в детстве купался... С уважения к тем, кто жил здесь до тебя.",
            next: 'continuation1'
        },
        'neutral_response': {
            text: "Вот именно! Это как у дерева корни - чем глубже, тем устойчивее к любым бурям. Знаешь, я часто думаю: настоящая любовь к Родине начинается не с громких слов, а с малого. С заботы о своём дворе, о парке, о речке, в которой в детстве купался... С уважения к тем, кто жил здесь до тебя.",
            next: 'continuation1'
        },
        'negative_response': {
            text: "Понимаю... Молодёжь сейчас другая. Всё куда-то спешат, смотрят вперёд. Но знаешь, я и сам когда-то таким был. Думал: главное - карьера, успех. А потом однажды весной увидел, как из-под снега подснежники пробиваются... И понял: есть вещи поважнее денег и должностей. Есть вечность.",
            next: 'continuation2'
        },
        
        'continuation1': {
            text: "Вот видишь тот старый дуб вон там? Под ним ещё мой прадед с односельнами собирался. Решали, кому помочь, чью крышу починить, чьих детей учить грамоте... Сейчас это называется 'волонтёрство', а тогда это была просто жизнь. Люди чувствовали себя частью одного целого, как ветви одного дерева.",
            next: 'story2'
        },
        'continuation2': {
            text: "Бывает, сижу я вечером на скамейке, смотрю на закат над нашим садом... И думаю: сколько же таких закатов видели эти деревья? Сколько поколений людей приходило сюда со своими радостями и печалями? И все они были частью чего-то большего, чем их собственная жизнь.",
            next: 'story2'
        },
        
        'story2': {
            text: "Помню, когда я только начинал работать в саду, тут был старичок один, Степаныч. 90 лет ему было, а он каждое утро приходил, саженцы проверял. Говорил: 'Я эти деревья ещё мальчишкой сажал'. А когда его не стало, мы нашли в сарае его дневники... Оказывается, он записывал, когда какое дерево посадил, кто ему помогал. Целая история сада в этих тетрадях.",
            next: 'reflection2'
        },
        'reflection2': {
            text: "Иногда молодые приходят ко мне: 'Дедушка, научите сажать деревья'. Я им не только про землю и удобрения рассказываю, но и про то, что они не просто яблони сажают, а память. Через 50 лет их внуки будут эти яблоки есть и вспоминать тех, кто их посадил. Вот что значит - оставить след.",
            next: 'question2'
        },
        'question2': "Как думаешь, что важнее для человека - искать новые земли или беречь и улучшать ту, что досталась от предков?",
        
        'positive_final': {
            text: "Верно сказал! Как дерево не может жить без корней, так и человек без связи с родной землёй - как перекати-поле. Но и только корнями жить нельзя - нужно и ветви к солнцу тянуть, новые побеги давать. Главное - помнить, откуда ты рос, и не стыдиться своих корней.",
            next: 'conclusion1'
        },
        'neutral_final': {
            text: "Верно сказал! Как дерево не может жить без корней, так и человек без связи с родной землёй - как перекати-поле. Но и только корнями жить нельзя - нужно и ветви к солнцу тянуть, новые побеги давать. Главное - помнить, откуда ты рос, и не стыдиться своих корней.",
            next: 'conclusion1'
        },
        'negative_final': {
            text: "Понимаю твои мысли... Молодость всегда рвётся к новым горизонтам. Но знаешь, я за свою долгую жизнь понял: где бы ты ни был, ты всегда берёшь с собой частичку родной земли. Как это дерево, которое можно пересадить, но его суть останется прежней. Новое - это хорошо, но забывать свои истоки - всё равно что рубить сук, на котором сидишь.",
            next: 'conclusion2'
        },
        
        'conclusion1': {
            text: "Спасибо, что выслушал старика. Знаешь, когда я смотрю на молодых, таких как ты, я верю, что не всё потеряно. Что будут ещё люди, которые поймут: Родина - это не абстрактное понятие. Это конкретный двор, конкретное дерево, конкретные люди, которые нуждаются в твоей заботе.",
            next: 'final'
        },
        'conclusion2': {
            text: "Каждый выбирает свой путь... Но помни: какие бы высоты ты ни покорял, всегда хорошо иметь место, куда можно вернуться. Как у этих птиц, что улетают на юг, но весной всегда возвращаются в свои гнёзда. Дом - это не стены, это место, где твоя душа находит покой.",
            next: 'final'
        },
        'final': "Заходи как-нибудь в сад - покажу тебе самые старые деревья, расскажу их истории. Может, и ты своё дерево посадишь... Чтобы через годы кто-то, глядя на него, вспомнил о тебе добрым словом. Всего тебе хорошего, сынок."
    },
    choices: {
        'question1': [
            { 
                text: "Да, чувствую связь с землёй", 
                value: 1,
                nextBranch: 'positive_response'
            },
            { 
                text: "Иногда задумываюсь об этом", 
                value: 2,
                nextBranch: 'neutral_response'
            },
            { 
                text: "Земля везде одинакова", 
                value: 3,
                nextBranch: 'negative_response'
            }
        ],
        'question2': [
            { 
                text: "Беречь родную землю", 
                value: 4,
                nextBranch: 'positive_final'
            },
            { 
                text: "Сочетать старое и новое", 
                value: 5,
                nextBranch: 'neutral_final'
            },
            { 
                text: "Искать новые возможности", 
                value: 6,
                nextBranch: 'negative_final'
            }
        ]
    }
})
]


const dialogueBox = new DialogueBox()
const choiceSystem = new ChoiceSystem(dialogueBox)
dialogueBox.choiceSystem = choiceSystem


const player = new Sprite({
    position: {
    x:canvas.width / 2 + 150,
    y:canvas.height / 2 
    },
    image: plDownImage,
    frames: {
        max: 4
    },
    sprites: {
        up: plUpImage,
        left: plLeftImage,
        right: plRightImage,
        down: plDownImage
    }
})


const background = new Sprite({
    position: {
        x: offset.x,
        y: offset.y
    },
    image: image
})


const foreground = new Sprite({
    position: {
        x: offset.x,
        y: offset.y
    },
    image: FGimage
})


const keys = {
  w: {
    pressed: false
  },
  a: {
    pressed: false
  },
  s: {
    pressed: false
  },
  d: {
    pressed: false
  }
}


const movables = [background, ...boundaries, foreground, ...characters]

function checkCharacterCollision() {
    for (let i = 0; i < characters.length; i++) {
        const character = characters[i]
        const interactionRange = 100
        
        const distance = Math.sqrt(
            Math.pow(player.position.x - character.position.x, 2) + 
            Math.pow(player.position.y - character.position.y, 2)
        )
        
        if (distance < interactionRange && !dialogueBox.isActive) {
            c.fillStyle = 'white'
            c.font = '20px Arial'
            c.fillText('Нажмите E для разговора', character.position.x - 50, character.position.y - 40)
            return character
        }
    }
    return null
}


function rectangularCollision({rectangle0,rectangle1}) {
    return (
        rectangle0.position.x + rectangle0.width >= rectangle1.position.x && 
        rectangle0.position.x <= rectangle1.position.x + rectangle1.width && 
        rectangle0.position.y <= rectangle1.position.y + rectangle1.height && 
        rectangle0.position.y + rectangle0.height >= rectangle1.position.y
    )
}



function animate() {
    window.requestAnimationFrame(animate)
    background.draw()
    boundaries.forEach((boundary) => {
        boundary.draw()

    
    })
    characters.forEach(character => {
        character.draw()
    })
    player.draw()
    foreground.draw()

    dialogueBox.draw()
    choiceSystem.draw()

    let moving = true
    player.moving = false

    if (dialogueBox.isActive) {
        moving = false
    }
    if (keys.w.pressed) {
    player.moving = true
    player.image = player.sprites.up
    for (let i = 0; i < boundaries.length; i++) {
        const boundary = boundaries[i]
        if (
            rectangularCollision({
                rectangle0: player,
                rectangle1: {...boundary, position: {
                    x: boundary.position.x,
                    y: boundary.position.y + 2
                }}
            })
        ) {
            moving = false
            break
        }
    }
    if (moving)
        movables.forEach((movable) => {movable.position.y += 2})
    
}
    else if (keys.a.pressed) {
    player.moving = true
    player.image = player.sprites.left    
    for (let i = 0; i < boundaries.length; i++) {
    const boundary = boundaries[i]
    if (
        rectangularCollision({
            rectangle0: player,
            rectangle1: {...boundary, position: {
                x: boundary.position.x + 2,
                y: boundary.position.y
            }}
        })
    ) {
        moving = false
        break
    }
    }
    if (moving)
        movables.forEach((movable) => {movable.position.x += 2})
}
    else if (keys.s.pressed) {
    player.moving = true
    player.image = player.sprites.down    
    for (let i = 0; i < boundaries.length; i++) {
    const boundary = boundaries[i]
    if (
        rectangularCollision({
            rectangle0: player,
            rectangle1: {...boundary, position: {
                x: boundary.position.x,
                y: boundary.position.y - 2
            }}
        })
    ) {
        moving = false
        break
    }
    }
    if (moving)
        movables.forEach((movable) => {movable.position.y -= 2})
}
    else if (keys.d.pressed) {
    player.moving = true
    player.image = player.sprites.right   
    for (let i = 0; i < boundaries.length; i++) {
    const boundary = boundaries[i]
    if (
        rectangularCollision({
            rectangle0: player,
            rectangle1: {...boundary, position: {
                x: boundary.position.x - 2,
                y: boundary.position.y
            }}
        })
    ) {
        moving = false
        break
    }
    }
    if (moving)
        movables.forEach((movable) => {movable.position.x -= 2})
}
}


animate()


window.addEventListener('keydown', (e) => {
    switch (e.key) {
        case 'w':
            keys.w.pressed = true
            break
        case 'a':
            keys.a.pressed = true
            break
        case 's':
            keys.s.pressed = true
            break
        case 'd':
            keys.d.pressed = true
            break
        case 'e':
         case 'E':
            if (choiceSystem.isActive) {
                choiceSystem.selectChoice()
            } else if (!dialogueBox.isActive) {
                const nearbyCharacter = checkCharacterCollision()
                if (nearbyCharacter) {
                    const content = nearbyCharacter.interact()
                    dialogueBox.show(nearbyCharacter, content)
                }
            } else {
                
                const nextContent = dialogueBox.currentCharacter.nextDialogue()
                if (nextContent) {
                    dialogueBox.show(dialogueBox.currentCharacter, nextContent)
                } else {
                    dialogueBox.hide()
                }
            }
            break
        case 'ArrowUp':
            if (choiceSystem.isActive) choiceSystem.previousChoice()
            break
        case 'ArrowDown':
            if (choiceSystem.isActive) choiceSystem.nextChoice()
            break
        case 'Enter':
            
            if (choiceSystem.isActive) {
                choiceSystem.selectChoice()
            }
            break
    }
})


window.addEventListener('keyup', (e) => {
    switch (e.key) {
        case 'w':
            keys.w.pressed = false
            break
        case 'a':
            keys.a.pressed = false
            break
        case 's':
            keys.s.pressed = false
            break
        case 'd':
            keys.d.pressed = false
            break
    }
}) 


let clicked = false
addEventListener('click', () => {
    if (!clicked) {
        if (Math.random() < 0.5)
        audio.Map.play()
    else 
        audio2.Map.play()
        clicked = true
   }
})

